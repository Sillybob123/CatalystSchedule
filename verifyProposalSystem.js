// ===============================
// PROPOSAL SYSTEM VERIFICATION
// Run this in browser console to check if everything is set up correctly
// ===============================

console.log('üîç Starting Proposal System Verification...');
console.log('==========================================\n');

// Test 1: Check if fix script loaded
console.log('‚úÖ TEST 1: Fix Script Loaded');
const fixLoaded = typeof window.handleProjectFormSubmit === 'function';
console.log(`   Result: ${fixLoaded ? '‚úÖ PASS' : '‚ùå FAIL'}`);
if (!fixLoaded) {
    console.error('   ‚Üí Fix script not loaded! Check if proposalSaveFix.js is included in HTML');
}
console.log('');

// Test 2: Check Firebase
console.log('‚úÖ TEST 2: Firebase Connection');
const firebaseOk = typeof firebase !== 'undefined' && firebase.firestore;
console.log(`   Result: ${firebaseOk ? '‚úÖ PASS' : '‚ùå FAIL'}`);
if (!firebaseOk) {
    console.error('   ‚Üí Firebase not initialized! Check Firebase scripts in HTML');
}
console.log('');

// Test 3: Check Database
console.log('‚úÖ TEST 3: Firestore Database');
const dbOk = typeof db !== 'undefined' && db;
console.log(`   Result: ${dbOk ? '‚úÖ PASS' : '‚ùå FAIL'}`);
if (!dbOk) {
    console.error('   ‚Üí Database not available! Check Firebase initialization');
}
console.log('');

// Test 4: Check User Authentication
console.log('‚úÖ TEST 4: User Authentication');
const userOk = typeof currentUser !== 'undefined' && currentUser;
console.log(`   Result: ${userOk ? '‚úÖ PASS' : '‚ùå FAIL'}`);
if (userOk) {
    console.log(`   ‚Üí User: ${currentUserName}`);
    console.log(`   ‚Üí Role: ${currentUserRole}`);
    console.log(`   ‚Üí UID: ${currentUser.uid}`);
} else {
    console.error('   ‚Üí Not logged in! Please log in first');
}
console.log('');

// Test 5: Check Form Elements
console.log('‚úÖ TEST 5: Form Elements');
const elements = {
    form: document.getElementById('project-form'),
    titleInput: document.getElementById('project-title'),
    typeSelect: document.getElementById('project-type'),
    proposalTextarea: document.getElementById('project-proposal'),
    deadlineInput: document.getElementById('project-deadline'),
    submitButton: document.getElementById('save-project-button'),
    modal: document.getElementById('project-modal'),
    addButton: document.getElementById('add-project-button')
};

let allElementsOk = true;
Object.entries(elements).forEach(([name, element]) => {
    const exists = !!element;
    console.log(`   ${exists ? '‚úÖ' : '‚ùå'} ${name}: ${exists ? 'Found' : 'Missing'}`);
    if (!exists) allElementsOk = false;
});
console.log(`   Result: ${allElementsOk ? '‚úÖ PASS' : '‚ùå FAIL'}`);
console.log('');

// Test 6: Check Required Functions
console.log('‚úÖ TEST 6: Required Functions');
const functions = {
    'handleProjectFormSubmit': window.handleProjectFormSubmit,
    'openProjectModal': window.openProjectModal,
    'closeAllModals': window.closeAllModals || closeAllModals,
    'showNotification': showNotification,
    'renderCurrentViewEnhanced': renderCurrentViewEnhanced
};

let allFunctionsOk = true;
Object.entries(functions).forEach(([name, func]) => {
    const exists = typeof func === 'function';
    console.log(`   ${exists ? '‚úÖ' : '‚ùå'} ${name}: ${exists ? 'Available' : 'Missing'}`);
    if (!exists) allFunctionsOk = false;
});
console.log(`   Result: ${allFunctionsOk ? '‚úÖ PASS' : '‚ùå FAIL'}`);
console.log('');

// Test 7: Check Subscription System
console.log('‚úÖ TEST 7: Subscription System');
const subscriptionsOk = typeof allProjects !== 'undefined' && Array.isArray(allProjects);
console.log(`   Result: ${subscriptionsOk ? '‚úÖ PASS' : '‚ùå FAIL'}`);
if (subscriptionsOk) {
    console.log(`   ‚Üí Projects loaded: ${allProjects.length}`);
    console.log(`   ‚Üí Tasks loaded: ${typeof allTasks !== 'undefined' ? allTasks.length : 0}`);
} else {
    console.error('   ‚Üí Subscriptions not working! Check fixedSubscriptions.js');
}
console.log('');

// Test 8: Check Current View
console.log('‚úÖ TEST 8: Current View');
const viewOk = typeof currentView !== 'undefined';
console.log(`   Result: ${viewOk ? '‚úÖ PASS' : '‚ùå FAIL'}`);
if (viewOk) {
    console.log(`   ‚Üí Current view: ${currentView}`);
}
console.log('');

// Summary
console.log('\n==========================================');
console.log('üìä VERIFICATION SUMMARY');
console.log('==========================================\n');

const allTests = [
    fixLoaded,
    firebaseOk,
    dbOk,
    userOk,
    allElementsOk,
    allFunctionsOk,
    subscriptionsOk,
    viewOk
];

const passedTests = allTests.filter(test => test).length;
const totalTests = allTests.length;

if (passedTests === totalTests) {
    console.log('üéâ ALL TESTS PASSED! System is ready to use.');
    console.log('   You can now create proposals successfully.');
} else {
    console.log(`‚ö†Ô∏è  ${passedTests}/${totalTests} tests passed`);
    console.log('   Some issues detected. Check the failed tests above.');
}

console.log('\n==========================================');
console.log('üß™ Quick Test Function');
console.log('==========================================\n');
console.log('To test proposal creation, run:');
console.log('testProposalCreation()');

// Create test function
window.testProposalCreation = async function() {
    console.log('üß™ Testing proposal creation...');
    
    if (!userOk) {
        console.error('‚ùå Cannot test: User not logged in');
        return;
    }
    
    if (!dbOk) {
        console.error('‚ùå Cannot test: Database not available');
        return;
    }
    
    const testData = {
        title: `Test Proposal - ${new Date().toLocaleTimeString()}`,
        type: 'Interview',
        proposal: 'This is a test proposal created by the verification script. You can delete it.',
        deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
        deadlines: {
            publication: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
            contact: '',
            interview: '',
            draft: '',
            review: '',
            edits: ''
        },
        authorId: currentUser.uid,
        authorName: currentUserName,
        editorId: null,
        editorName: null,
        proposalStatus: 'pending',
        timeline: {
            "Topic Proposal Complete": false,
            "Interview Scheduled": false,
            "Interview Complete": false,
            "Article Writing Complete": false,
            "Review In Progress": false,
            "Review Complete": false,
            "Suggestions Reviewed": false
        },
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        activity: [{
            text: 'created the project (TEST)',
            authorName: currentUserName,
            timestamp: new Date()
        }]
    };
    
    try {
        console.log('   Creating test proposal...');
        const docRef = await db.collection('projects').add(testData);
        console.log('‚úÖ SUCCESS! Test proposal created');
        console.log(`   Document ID: ${docRef.id}`);
        console.log('   Check your board - it should appear in "Pending Approval"');
        console.log('   You can delete it from the project details modal');
    } catch (error) {
        console.error('‚ùå FAILED to create test proposal');
        console.error(`   Error: ${error.message}`);
        if (error.code === 'permission-denied') {
            console.error('   ‚Üí Check your Firestore security rules!');
            console.error('   ‚Üí Go to Firebase Console ‚Üí Firestore ‚Üí Rules');
            console.error('   ‚Üí Ensure "allow create: if request.auth != null;" is present');
        }
    }
};

console.log('\n‚úÖ Verification complete! Scroll up to see results.');
