<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Catalyst â€“ Team Board</title>
  <meta name="description" content="A beautiful, intuitive, and real-time Kanban board for The Catalyst Magazine team, built with Firebase." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom Scrollbar for a more polished look */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1f2937; }
    ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

    /* Basic styles and theme */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #030712;
      color: #f9fafb;
    }
    .kanban-board {
      display: flex;
      gap: 1.5rem; /* 24px */
      overflow-x: auto;
      padding-bottom: 1.5rem;
    }
    .kanban-column {
      flex: 0 0 320px;
      max-height: calc(100vh - 200px);
      display: flex;
      flex-direction: column;
    }
    .kanban-cards {
      overflow-y: auto;
      flex-grow: 1;
      padding-right: 8px; /* space for scrollbar */
    }
    .kanban-card {
      cursor: grab;
      transition: background-color 0.2s, box-shadow 0.2s;
    }
    .kanban-card:active {
      cursor: grabbing;
    }
    .dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }
    .drag-over {
        border-color: #3b82f6;
        background-color: rgba(59, 130, 246, 0.1);
    }
  </style>
</head>
<body class="antialiased">

  <!-- Full Screen Loader -->
  <div id="loader" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="text-gray-400 text-lg">Loading Catalyst Board...</div>
  </div>

  <div id="app-container" class="hidden">
    <!-- Header -->
    <header class="bg-gray-900/70 backdrop-blur-lg border-b border-gray-700/50 sticky top-0 z-30">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center space-x-4">
            <svg class="h-8 w-8 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
            <h1 class="text-xl font-bold text-white">Catalyst Board</h1>
          </div>
          <div id="auth-container" class="flex items-center space-x-4">
            <!-- Auth info will be injected here -->
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Board -->
      <div id="kanban-board" class="kanban-board">
        <!-- Columns will be injected here -->
      </div>
    </main>
  </div>

  <!-- Add/Edit Task Modal -->
  <div id="task-modal" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-40 hidden items-center justify-center">
    <div class="bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
      <div class="flex items-center justify-between p-4 border-b border-gray-700">
        <h2 id="modal-title" class="text-lg font-bold text-white">Create New Article Task</h2>
        <button id="close-modal-btn" class="text-gray-400 hover:text-white">&times;</button>
      </div>
      <div class="p-6 overflow-y-auto">
        <form id="task-form" class="space-y-4">
          <input type="hidden" id="f-id">
          <div>
            <label for="f-title" class="block text-sm font-medium text-gray-300">Article Title</label>
            <input type="text" id="f-title" required class="mt-1 block w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="f-owner" class="block text-sm font-medium text-gray-300">Owner</label>
              <select id="f-owner" class="mt-1 block w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
            </div>
            <div>
              <label for="f-priority" class="block text-sm font-medium text-gray-300">Priority</label>
              <select id="f-priority" class="mt-1 block w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <option>Low</option><option selected>Medium</option><option>High</option>
              </select>
            </div>
          </div>
          <div>
            <label for="f-due" class="block text-sm font-medium text-gray-300">Due Date</label>
            <input type="date" id="f-due" class="mt-1 block w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <label for="f-link" class="block text-sm font-medium text-gray-300">Document Link</label>
            <input type="url" id="f-link" placeholder="https://docs.google.com/..." class="mt-1 block w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <label for="f-notes" class="block text-sm font-medium text-gray-300">Notes</label>
            <textarea id="f-notes" rows="4" class="mt-1 block w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
          </div>
          <div class="flex justify-end space-x-3 pt-4">
            <button type="button" id="delete-task-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600/50 hover:bg-red-600 rounded-md hidden">Delete</button>
            <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">Save Task</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Notification Modal -->
  <div id="notify-modal" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 hidden items-center justify-center">
      <div class="bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
          <h3 id="notify-title" class="text-lg font-bold text-white">Notification</h3>
          <p id="notify-message" class="mt-2 text-sm text-gray-300"></p>
          <div id="notify-actions" class="mt-6 flex justify-center space-x-4">
              <button id="notify-ok" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">OK</button>
              <button id="notify-cancel" class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 hover:bg-gray-600 rounded-md hidden">Cancel</button>
          </div>
      </div>
  </div>


  <script type="module">
    // ===== Firebase Configuration =====
    const CONFIG = {
      apiKey: 'AIzaSyBT6urJvPCtuYQ1c2iH77QTDfzE3yGw-Xk',
      authDomain: 'catalystmonday.firebaseapp.com',
      projectId: 'catalystmonday',
      storageBucket: 'catalystmonday.appspot.com',
      messagingSenderId: '394311851220'
    };

    // ===== Application Constants =====
    const ALLOWLIST_EMAILS = [
        "yairbendor@gwmail.gwu.edu", "ac6892@princeton.edu",
        "acarter45@gwu.edu", "act128@georgetown.edu",
        "aidan.schurr@gwmail.gwu.edu", "aidan.schurr@gwu.edu",
        "aidansbrown@gwmail.gwu.edu", "atcarter2002@gmail.com",
        "azzarreeu@gwmail.gwu.edu", "ginger.taurek@gwmail.gwu.edu",
        "loripreci@gwmail.gwu.edu", "loripreci03@gmail.com",
        "Naama.bendor1@gmail.com", "nb852@georgetown.edu",
        "rachel.lee@gwmail.gwu.edu", "sas562@georgetown.edu",
        "stemcatalystmagazine@gmail.com", "bendoryair@gmail.com"
    ];
    const ALLOWED_DOMAINS = ['gwu.edu','georgetown.edu','princeton.edu','howard.edu','jhu.edu'];
    const TEAM = [
      { name: 'Yair Ben-Dor', role: 'Co-Founder, Editor-in-Chief, Website Developer', avatar: `https://api.dicebear.com/7.x/initials/svg?seed=Yair Ben-Dor` },
      { name: 'Aidan Schurr', role: 'Co-Founder, Editor-in-Chief', avatar: `https://api.dicebear.com/7.x/initials/svg?seed=Aidan Schurr` },
      { name: 'Lori Preci', role: 'Senior Writer', avatar: `https://api.dicebear.com/7.x/initials/svg?seed=Lori Preci` },
      { name: 'Naama Ben-Dor', role: 'Managing Editor', avatar: `https://api.dicebear.com/7.x/initials/svg?seed=Naama Ben-Dor` },
      { name: 'Stephanie Solomon', role: 'Managing Editor', avatar: `https://api.dicebear.com/7.x/initials/svg?seed=Stephanie Solomon` },
      { name: 'Alex Carter', role: 'Writer', avatar: `https://api.dicebear.com/7.x/initials/svg?seed=Alex Carter` },
      { name: 'Ginger Taurek', role: 'Writer', avatar: `https://api.dicebear.com/7.x/initials/svg?seed=Ginger Taurek` },
      { name: 'Aidan Brown', role: 'Writer', avatar: `https://api.dicebear.com/7.x/initials/svg?seed=Aidan Brown` },
      { name: 'Azza Uwhubetine', role: 'Writer', avatar: `https://api.dicebear.com/7.x/initials/svg?seed=Azza Uwhubetine` },
      { name: 'Alexis Tamm', role: 'Writer', avatar: `https://api.dicebear.com/7.x/initials/svg?seed=Alexis Tamm` },
      { name: 'Layla Abdoulaye', role: 'Writer', avatar: `https://api.dicebear.com/7.x/initials/svg?seed=Layla Abdoulaye` },
      { name: 'Rachel Lee', role: 'Photographer', avatar: `https://api.dicebear.com/7.x/initials/svg?seed=Rachel Lee` },
    ];
    const STAGES = ['Pitch', 'Researching', 'Drafting', 'Editing', 'Published', 'On Hold'];
    const PRIORITY_STYLES = {
        'High': 'bg-red-500/20 text-red-300 border-red-500/30',
        'Medium': 'bg-yellow-500/20 text-yellow-300 border-yellow-500/30',
        'Low': 'bg-sky-500/20 text-sky-300 border-sky-500/30',
    };

    // ===== Global State =====
    const state = {
        user: null,
        tasks: [],
        firebase: null,
        store: null,
    };

    // ===== DOM Elements =====
    const $ = (selector) => document.querySelector(selector);
    const loader = $('#loader');
    const appContainer = $('#app-container');
    const authContainer = $('#auth-container');
    const kanbanBoard = $('#kanban-board');
    const taskModal = $('#task-modal');
    const taskForm = $('#task-form');
    const modalTitle = $('#modal-title');
    const closeModalBtn = $('#close-modal-btn');
    const deleteTaskBtn = $('#delete-task-btn');
    
    // ===== Notification System =====
    let notifyResolve = null;
    function notify(message, title = 'Notification', isConfirm = false) {
        return new Promise(resolve => {
            notifyResolve = resolve;
            $('#notify-title').textContent = title;
            $('#notify-message').textContent = message;
            $('#notify-cancel').classList.toggle('hidden', !isConfirm);
            $('#notify-modal').classList.remove('hidden');
            $('#notify-modal').classList.add('flex');
        });
    }
    $('#notify-ok').onclick = () => {
        $('#notify-modal').classList.add('hidden');
        $('#notify-modal').classList.remove('flex');
        if (notifyResolve) notifyResolve(true);
    };
    $('#notify-cancel').onclick = () => {
        $('#notify-modal').classList.add('hidden');
        $('#notify-modal').classList.remove('flex');
        if (notifyResolve) notifyResolve(false);
    };

    // ===== Auth Logic =====
    function canEdit() {
        if (!state.user) return false;
        if (ALLOWLIST_EMAILS.includes(state.user.email)) return true;
        const domain = (state.user.email || '').split('@')[1] || '';
        return ALLOWED_DOMAINS.includes(domain);
    }

    function renderAuthUI() {
        if (state.user) {
            const userTeamInfo = TEAM.find(t => t.name.toLowerCase().includes(state.user.displayName.split(' ')[0].toLowerCase()));
            authContainer.innerHTML = `
                <div class="flex items-center space-x-3">
                    <img src="${userTeamInfo?.avatar || `https://api.dicebear.com/7.x/initials/svg?seed=${state.user.displayName}`}" alt="avatar" class="h-8 w-8 rounded-full">
                    <span class="text-sm font-medium text-white">${state.user.displayName}</span>
                    <button id="sign-out-btn" class="px-3 py-1 text-sm bg-gray-700 hover:bg-gray-600 rounded-md">Sign Out</button>
                </div>
            `;
            $('#sign-out-btn').onclick = () => state.firebase.signOut(state.firebase.auth);
        } else {
            authContainer.innerHTML = `<button id="sign-in-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">Sign In with Google</button>`;
            $('#sign-in-btn').onclick = () => {
                const provider = new state.firebase.GoogleAuthProvider();
                state.firebase.signInWithRedirect(state.firebase.auth, provider);
            };
        }
    }

    // ===== Kanban Board Rendering =====
    function renderBoard() {
        kanbanBoard.innerHTML = '';
        STAGES.forEach(stage => {
            const column = document.createElement('div');
            column.className = 'kanban-column';
            column.dataset.stage = stage;
            
            const stageTasks = state.tasks.filter(task => task.stage === stage);
            
            column.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold text-white">${stage}</h3>
                    <span class="text-sm text-gray-400 bg-gray-700/50 px-2 py-1 rounded-md">${stageTasks.length}</span>
                </div>
                <div class="kanban-cards space-y-3" data-stage-cards="${stage}">
                    <!-- Cards will be injected here -->
                </div>
            `;
            kanbanBoard.appendChild(column);
            renderCards(stage);
        });
        
        // Add "New Task" button to the "Pitch" column
        const pitchColumn = kanbanBoard.querySelector('[data-stage="Pitch"]');
        if (pitchColumn && canEdit()) {
            const newTaskBtn = document.createElement('button');
            newTaskBtn.className = 'mt-4 w-full text-left px-3 py-2 text-sm text-gray-400 hover:bg-gray-700/50 rounded-md';
            newTaskBtn.innerHTML = '+ New Article Pitch';
            newTaskBtn.onclick = () => openTaskModal();
            pitchColumn.appendChild(newTaskBtn);
        }
    }

    function renderCards(stage) {
        const container = kanbanBoard.querySelector(`[data-stage-cards="${stage}"]`);
        if (!container) return;

        const stageTasks = state.tasks.filter(task => task.stage === stage);
        container.innerHTML = ''; // Clear existing cards
        
        if (stageTasks.length === 0) {
            container.innerHTML = `<div class="text-center text-sm text-gray-500 py-4">No tasks here.</div>`;
        } else {
            stageTasks.forEach(task => {
                const card = document.createElement('div');
                card.id = `task-${task.id}`;
                card.className = 'kanban-card bg-gray-800 p-4 rounded-lg border border-gray-700 shadow-md';
                card.draggable = canEdit();
                card.dataset.taskId = task.id;

                const owner = TEAM.find(t => t.name === task.owner);
                
                card.innerHTML = `
                    <h4 class="font-semibold text-white mb-2">${task.title}</h4>
                    <div class="flex items-center justify-between text-xs text-gray-400">
                        <div class="flex items-center space-x-2">
                            ${owner ? `<img src="${owner.avatar}" class="h-5 w-5 rounded-full" title="${owner.name}">` : ''}
                            <span>${task.owner}</span>
                        </div>
                        <span class="px-2 py-1 rounded ${PRIORITY_STYLES[task.priority] || ''}">${task.priority}</span>
                    </div>
                `;
                card.onclick = () => openTaskModal(task);
                container.appendChild(card);
            });
        }
    }
    
    // ===== Drag and Drop Logic =====
    function setupDragAndDrop() {
        kanbanBoard.addEventListener('dragstart', e => {
            if (e.target.classList.contains('kanban-card')) {
                e.target.classList.add('dragging');
                e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
            }
        });

        kanbanBoard.addEventListener('dragend', e => {
            if (e.target.classList.contains('kanban-card')) {
                e.target.classList.remove('dragging');
            }
        });

        kanbanBoard.addEventListener('dragover', e => {
            e.preventDefault();
            const column = e.target.closest('.kanban-column');
            if (column) {
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                column.querySelector('.kanban-cards').classList.add('drag-over');
            }
        });
        
        kanbanBoard.addEventListener('dragleave', e => {
            const column = e.target.closest('.kanban-column');
            if (column) {
                column.querySelector('.kanban-cards').classList.remove('drag-over');
            }
        });

        kanbanBoard.addEventListener('drop', async e => {
            e.preventDefault();
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            const column = e.target.closest('.kanban-column');
            if (column) {
                const taskId = e.dataTransfer.getData('text/plain');
                const newStage = column.dataset.stage;
                const task = state.tasks.find(t => t.id === taskId);
                if (task && task.stage !== newStage) {
                    await state.store.updateItem(taskId, { stage: newStage });
                }
            }
        });
    }


    // ===== Modal Logic =====
    function openTaskModal(task = null) {
        if (!canEdit()) {
            return notify("You have read-only access and cannot edit tasks.", "Permission Denied");
        }
        taskForm.reset();
        if (task) {
            modalTitle.textContent = 'Edit Article Task';
            $('#f-id').value = task.id;
            $('#f-title').value = task.title;
            $('#f-owner').value = task.owner;
            $('#f-priority').value = task.priority;
            $('#f-due').value = task.due;
            $('#f-link').value = task.link;
            $('#f-notes').value = task.notes;
            deleteTaskBtn.classList.remove('hidden');
        } else {
            modalTitle.textContent = 'Create New Article Task';
            $('#f-id').value = '';
            $('#f-owner').value = TEAM[0].name;
            $('#f-priority').value = 'Medium';
            deleteTaskBtn.classList.add('hidden');
        }
        taskModal.classList.remove('hidden');
        taskModal.classList.add('flex');
    }

    function closeTaskModal() {
        taskModal.classList.add('hidden');
        taskModal.classList.remove('flex');
    }
    closeModalBtn.onclick = closeTaskModal;
    
    taskForm.onsubmit = async (e) => {
        e.preventDefault();
        const id = $('#f-id').value;
        const payload = {
            title: $('#f-title').value.trim(),
            owner: $('#f-owner').value,
            priority: $('#f-priority').value,
            due: $('#f-due').value,
            link: $('#f-link').value.trim(),
            notes: $('#f-notes').value.trim(),
            stage: id ? state.tasks.find(t => t.id === id).stage : 'Pitch',
        };

        if (id) {
            await state.store.updateItem(id, payload);
        } else {
            await state.store.addItem(payload);
        }
        closeTaskModal();
    };
    
    deleteTaskBtn.onclick = async () => {
        const id = $('#f-id').value;
        const confirmed = await notify("Are you sure you want to delete this task? This cannot be undone.", "Confirm Deletion", true);
        if (confirmed && id) {
            await state.store.deleteItem(id);
            closeTaskModal();
        }
    };

    // ===== Data Store =====
    class FirestoreDataStore {
        constructor(fb) { this.fb = fb; }
        init(onChange) {
            const { db, collection, query, orderBy, onSnapshot } = this.fb;
            const q = query(collection(db, 'catalyst_tasks'), orderBy('createdAt', 'desc'));
            onSnapshot(q, snapshot => {
                const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                onChange(tasks);
            });
        }
        async addItem(item) {
            const { db, collection, addDoc, serverTimestamp } = this.fb;
            await addDoc(collection(db, 'catalyst_tasks'), {
                ...item,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
            });
        }
        async updateItem(id, changes) {
            const { db, doc, updateDoc, serverTimestamp } = this.fb;
            await updateDoc(doc(db, 'catalyst_tasks', id), {
                ...changes,
                updatedAt: serverTimestamp(),
            });
        }
        async deleteItem(id) {
            const { db, doc, deleteDoc } = this.fb;
            await deleteDoc(doc(db, 'catalyst_tasks', id));
        }
    }

    // ===== Initialization =====
    async function init() {
        // Populate static dropdowns
        const ownerSelect = $('#f-owner');
        TEAM.forEach(member => {
            ownerSelect.innerHTML += `<option>${member.name}</option>`;
        });

        try {
            // Dynamically import Firebase modules
            const [appMod, authMod, fsMod] = await Promise.all([
                import('https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js'),
                import('https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js'),
                import('https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js')
            ]);

            const app = appMod.initializeApp(CONFIG);
            const auth = authMod.getAuth(app);
            const db = fsMod.getFirestore(app);

            state.firebase = {
                app, auth, db,
                GoogleAuthProvider: authMod.GoogleAuthProvider,
                signInWithRedirect: authMod.signInWithRedirect,
                getRedirectResult: authMod.getRedirectResult,
                signOut: authMod.signOut,
                onAuthStateChanged: authMod.onAuthStateChanged,
                ...fsMod
            };

            state.store = new FirestoreDataStore(state.firebase);

            // Set up the primary auth listener
            state.firebase.onAuthStateChanged(auth, user => {
                state.user = user ? {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                } : null;
                
                renderAuthUI();
                renderBoard(); // Re-render board to apply edit permissions
                setupDragAndDrop();

                if (user && !canEdit()) {
                    notify(`Welcome, ${user.displayName}! You have read-only access.`, "Permissions Notice");
                }
                
                loader.classList.add('hidden');
                appContainer.classList.remove('hidden');
            });
            
            // Handle the redirect result
            await state.firebase.getRedirectResult(auth).catch(err => {
                console.error("Auth redirect error:", err);
                notify(`Sign-in failed: ${err.message}`, "Authentication Error");
            });

            // Start listening for data changes
            state.store.init(tasks => {
                state.tasks = tasks;
                renderBoard();
            });

        } catch (error) {
            console.error("Initialization failed:", error);
            loader.classList.add('hidden');
            document.body.innerHTML = `<div class="text-center text-red-400 p-8">Failed to load the application. Please check the console for errors.</div>`;
        }
    }

    init();
  </script>
</body>
</html>
