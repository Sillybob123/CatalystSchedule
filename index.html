<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Catalyst – Team Board</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0e1116;--panel:#111827;--muted:#9CA3AF;--text:#E5E7EB;--brand:#60A5FA;--brand2:#A78BFA;--rad:14px}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:#0e1116}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:#111827;border-bottom:1px solid #1f2937}
    h1{margin:0;font-size:18px}
    .muted{color:var(--muted)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .bar{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    button{padding:8px 12px;border-radius:8px;border:1px solid #374151;background:#1f2937;color:#E5E7EB;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#3b82f6,#2563eb);border-color:#1d4ed8;color:#fff}
    #msg{margin:0 0 12px;background:#111827;border:1px solid #1f2937;border-radius:var(--rad);padding:10px 12px;display:none}
    table{width:100%;border-collapse:separate;border-spacing:0;background:#111827;border:1px solid #1f2937;border-radius:var(--rad);overflow:hidden}
    thead th{background:#0f172a;text-align:left;padding:12px;border-bottom:1px solid #1f2937;font-weight:600}
    tbody td{padding:12px;border-bottom:1px solid #1f2937;vertical-align:top}
    tr:hover{background:#0b1324}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #374151}
    .blue{background:#0b2748;color:#93c5fd}
    .green{background:#052d23;color:#6ee7b7}
    .amber{background:#321e02;color:#fcd34d}
    .red{background:#34090a;color:#fca5a5}
    .progress{height:8px;background:#0b1324;border:1px solid #1f2937;border-radius:999px;overflow:hidden}
    .progress>div{height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2))}
    .right{margin-left:auto}
    a{color:#93c5fd}
    .small{font-size:12px}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>The Catalyst – Team Board</h1>
      <div class="small muted">Track pitches → interviews → drafts → edits → publication</div>
    </div>
    <div class="bar">
      <span id="whoami" class="small muted">Not signed in</span>
      <button id="btnSignIn">Sign in with Google</button>
      <button id="btnSignOut" style="display:none">Sign out</button>
    </div>
  </header>

  <div class="wrap">
    <div id="msg"></div>

    <div class="bar">
      <input id="q" type="search" placeholder="Search title or notes…" style="flex:1;min-width:220px;background:#111827;border:1px solid #1f2937;border-radius:8px;padding:8px 10px;color:#E5E7EB">
      <select id="owner" style="background:#111827;border:1px solid #1f2937;border-radius:8px;padding:8px 10px;color:#E5E7EB"><option value="">Owner: All</option></select>
      <select id="stage" style="background:#111827;border:1px solid #1f2937;border-radius:8px;padding:8px 10px;color:#E5E7EB"><option value="">Stage: All</option></select>
      <select id="prio"  style="background:#111827;border:1px solid #1f2937;border-radius:8px;padding:8px 10px;color:#E5E7EB"><option value="">Priority: All</option><option>Low</option><option>Medium</option><option>High</option></select>
      <button id="btnNew" class="primary right">+ New Item</button>
    </div>

    <table aria-label="Team Board">
      <thead><tr>
        <th>Title</th>
        <th>Owner</th>
        <th>Stage</th>
        <th>Status</th>
        <th>Progress</th>
        <th>Due</th>
        <th>Priority</th>
        <th>Notes</th>
        <th>Updated</th>
        <th></th>
      </tr></thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <script type="module">
    // --- Firebase (your project) ---
    const CONFIG = {
      apiKey: "AIzaSyBT6urJvPCtuYQ1c2iH77QTDfzE3yGw-Xk",
      authDomain: "catalystmonday.firebaseapp.com",
      projectId: "catalystmonday",
      storageBucket: "catalystmonday.appspot.com",
      messagingSenderId: "394311851220"
    };

    // --- Stages & status ---
    const STAGES = ['Pitch','Researching','Interviewing','Drafting','Editing','Ready for Publication','Published','On Hold'];
    const STATUS = [
      { key:'Not Started', color:'red' },
      { key:'In Progress', color:'blue' },
      { key:'Needs Review', color:'amber' },
      { key:'Approved', color:'green' }
    ];

    // --- Helpers ---
    const $ = s => document.querySelector(s);
    const show = (el, ok=true)=> el.style.display = ok ? '' : 'none';
    const msgBox = $('#msg');
    function message(text, type='info'){ msgBox.textContent=text; msgBox.style.display=text ? 'block' : 'none'; }

    function statusPill(key){ const e=STATUS.find(s=>s.key===key) || STATUS[0]; return `<span class="pill ${e.color}">${e.key}</span>`; }
    function stagePill(stage){
      const c = stage==='Ready for Publication' || stage==='Published' ? 'green'
            : stage==='Editing' || stage==='Drafting' ? 'amber'
            : stage==='Interviewing' || stage==='Researching' ? 'blue' : 'red';
      return `<span class="pill ${c}">${stage}</span>`;
    }
    const clamp = (n,min,max)=> Math.max(min, Math.min(max, n));
    const fmtUpdated = (u)=> u?.seconds ? new Date(u.seconds*1000).toLocaleString() : (u ? new Date(u).toLocaleString() : '');

    // --- Owners (from team list you gave me) ---
    const OWNERS = [
      'Yair Ben-Dor','Aidan Schurr','Lori Preci','Naama Ben-Dor','Stephanie Solomon',
      'Alex Carter','Ginger Taurek','Aidan Brown','Azza Uwhubetine','Alexis Tamm',
      'Layla Abdoulaye','Rachel Lee'
    ];
    const ownerSel = $('#owner'); OWNERS.forEach(n=>{const o=document.createElement('option');o.textContent=n;ownerSel.append(o);});
    const stageSel = $('#stage'); STAGES.forEach(s=>{const o=document.createElement('option');o.textContent=s;stageSel.append(o);});

    // --- Firebase SDKs (loaded via ES modules) ---
    const appMod = await import('https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js');
    const authMod = await import('https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js');
    const fsMod   = await import('https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js');

    const app = appMod.initializeApp(CONFIG);
    const auth = authMod.getAuth(app);
    const db   = fsMod.getFirestore(app);

    // Use redirect flow to avoid popup blockers on GitHub Pages
    $('#btnSignIn').onclick = async () => {
      try {
        const provider = new authMod.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        await authMod.signInWithRedirect(auth, provider);
      } catch(err) {
        console.error(err);
        message('Could not start Google sign-in: ' + err.message);
      }
    };
    $('#btnSignOut').onclick = async () => { try { await authMod.signOut(auth); } catch(err){ message('Sign-out error: '+err.message); } };

    // Complete redirect sign-in if returning from Google
    try { await authMod.getRedirectResult(auth); } catch(err){ console.error(err); message('Sign-in error: ' + err.message); }

    // Update header
    authMod.onAuthStateChanged(auth, u=>{
      $('#whoami').textContent = u ? `Signed in as ${u.displayName || u.email}` : 'Not signed in';
      show($('#btnSignIn'), !u);
      show($('#btnSignOut'), !!u);
    });

    // --- Firestore live view ---
    const rowsEl = $('#rows');
    function renderRow(it, id){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${(it.title||'').replace(/</g,'&lt;')}</strong><div class="small muted">${id.slice(0,6)}</div></td>
        <td>${it.owner||''}</td>
        <td>${stagePill(it.stage||'Pitch')}</td>
        <td>${statusPill(it.status||'Not Started')}</td>
        <td>
          <div class="progress" title="${it.progress||0}%"><div style="width:${clamp(+it.progress||0,0,100)}%"></div></div>
          <div class="small muted">${clamp(+it.progress||0,0,100)}%</div>
        </td>
        <td>${it.due||''}</td>
        <td>${it.priority||''}</td>
        <td>${it.notes ? it.notes.replace(/</g,'&lt;') : '—'}</td>
        <td>${fmtUpdated(it.updatedAt)}</td>
        <td><button data-edit="${id}">Edit</button> <button data-del="${id}">Del</button></td>`;
      return tr;
    }

    // Search/filters
    const filter = ()=> {
      const q = ($('#q').value||'').toLowerCase();
      const ow= ownerSel.value; const st= stageSel.value; const pr=$('#prio').value;
      [...rowsEl.children].forEach(tr=>{
        const t = tr.getAttribute('data-text') || '';
        const o = tr.getAttribute('data-owner') || '';
        const s = tr.getAttribute('data-stage') || '';
        const p = tr.getAttribute('data-priority') || '';
        const showRow = (!q || t.includes(q)) && (!ow || o===ow) && (!st || s===st) && (!pr || p===pr);
        tr.style.display = showRow ? '' : 'none';
      });
    };
    $('#q').oninput = filter; ownerSel.onchange = filter; stageSel.onchange = filter; $('#prio').onchange = filter;

    // Subscribe to Firestore (public read)
    const qRef = fsMod.query(fsMod.collection(db,'catalyst_board'), fsMod.orderBy('updatedAt','desc'));
    fsMod.onSnapshot(qRef, snap=>{
      rowsEl.innerHTML='';
      snap.forEach(doc=>{
        const it = doc.data();
        const tr = renderRow(it, doc.id);
        tr.setAttribute('data-text', (`${it.title||''} ${it.notes||''}`).toLowerCase());
        tr.setAttribute('data-owner', it.owner||'');
        tr.setAttribute('data-stage', it.stage||'');
        tr.setAttribute('data-priority', it.priority||'');
        rowsEl.append(tr);
      });
      filter();
    }, err=>{
      console.error(err);
      message('Could not load board: ' + err.message);
    });

    // Add / Edit / Delete
    async function upsertItem(existingId){
      const u = auth.currentUser;
      if(!u){ message('Please sign in to add or edit items.'); return; }
      // very simple prompts to keep single-file; replace with a modal later if you like
      const title = prompt('Article title?'); if(!title) return;
      const owner = prompt('Owner (leave blank to use your name/email):') || (u.displayName || u.email || 'Unknown');
      const stage = prompt('Stage (Pitch, Researching, Interviewing, Drafting, Editing, Ready for Publication, Published, On Hold):','Pitch') || 'Pitch';
      const status= prompt('Status (Not Started, In Progress, Needs Review, Approved):','In Progress') || 'In Progress';
      const progress = parseInt(prompt('Progress % (0-100):','0')||'0',10);
      const due = prompt('Due date (YYYY-MM-DD):','') || '';
      const priority = prompt('Priority (Low, Medium, High):','Medium') || 'Medium';
      const notes = prompt('Notes:','') || '';

      try{
        if(existingId){
          await fsMod.updateDoc(fsMod.doc(db,'catalyst_board',existingId), {
            title, owner, stage, status, progress, due, priority, notes,
            updatedAt: fsMod.serverTimestamp()
          });
        }else{
          await fsMod.addDoc(fsMod.collection(db,'catalyst_board'), {
            title, owner, stage, status, progress, due, priority, notes,
            createdAt: fsMod.serverTimestamp(),
            updatedAt: fsMod.serverTimestamp()
          });
        }
      }catch(err){ message('Save failed: '+err.message); }
    }

    async function deleteItem(id, title){
      const u = auth.currentUser;
      if(!u){ message('Please sign in to delete items.'); return; }
      if(!confirm(`Delete “${title}”? This cannot be undone.`)) return;
      try{ await fsMod.deleteDoc(fsMod.doc(db,'catalyst_board',id)); }
      catch(err){ message('Delete failed: '+err.message); }
    }

    $('#btnNew').onclick = ()=> upsertItem(null);

    rowsEl.addEventListener('click', (e)=>{
      const editId = e.target.getAttribute('data-edit');
      const delId  = e.target.getAttribute('data-del');
      if(editId){ const t = e.target.closest('tr').querySelector('td').innerText; upsertItem(editId); }
      if(delId){  const t = e.target.closest('tr').querySelector('td').innerText; deleteItem(delId, t); }
    });
  </script>
</body>
</html>
